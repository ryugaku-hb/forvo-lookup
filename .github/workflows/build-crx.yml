# GitHub Actions å·¥ä½œæµåç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ Actions é¡µé¢ä¸Š
name: Build and Release CRX

# name: string
# é¡¶å±‚
# å·¥ä½œæµåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢

# on: {object | string | array}
# é¡¶å±‚ï¼Œå¿…å¡«
# æŒ‡å®šè§¦å‘ workflow çš„äº‹ä»¶ï¼ˆå¦‚ push, pull_request, workflow_dispatchï¼‰

# å·¥ä½œæµçš„è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç è¢« push ä¸”å¸¦æœ‰ Git æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰æ—¶è§¦å‘
on:
  # `push` è¡¨ç¤ºâ€œå½“æœ‰äºº push ä»£ç åˆ° GitHubâ€æ—¶è§¦å‘
  push:
    # `tags` è¿›ä¸€æ­¥é™å®šä¸ºâ€œåªæœ‰ push æ ‡ç­¾â€æ‰è§¦å‘
    tags:
      # åªåŒ¹é…ä»¥ "v" å¼€å¤´çš„æ ‡ç­¾ï¼Œæ¯”å¦‚ v1.0ã€v2.3.4
      - "v*"

# jobs: object
# é¡¶å±‚ï¼Œå¿…å¡«
# åŒ…å«æ‰€æœ‰ä»»åŠ¡ï¼ˆjobï¼‰å®šä¹‰ï¼Œæ¯ä¸ª job åŒ…æ‹¬æ‰§è¡Œå™¨ä¸æ­¥éª¤

# job-id: string
# job å±‚ï¼Œå¿…å¡«
# ä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ build æˆ– testï¼Œå¯è‡ªå®šä¹‰

# runs-on: string
# job å±‚ï¼Œå¿…å¡«
# æŒ‡å®šè¿è¡Œç¯å¢ƒï¼ˆå¦‚ ubuntu-latestï¼‰

jobs:
  # æœ¬ job çš„ IDï¼Œä½ å¯ä»¥ç”¨å…¶ä»–åå­—æ›¿ä»£ï¼Œæ¯”å¦‚ package-extension
  build:
    # GitHub æä¾›çš„äº‘ç«¯ Linux ç¯å¢ƒï¼Œé»˜è®¤æœ€æ–° Ubuntu
    runs-on: ubuntu-latest

    # steps: array
    # job å±‚ï¼Œå¿…å¡«
    # å®šä¹‰æ‰§è¡Œæ­¥éª¤åˆ—è¡¨ï¼ˆæ¯ä¸ªæ˜¯ä¸€ä¸ª stepï¼‰

    steps: # `steps` æ¯ä¸ªä»»åŠ¡ä¸­çš„å…·ä½“æ­¥éª¤
      - name: Checkout code
        # æ‹‰å–å½“å‰ä»“åº“çš„ä»£ç ï¼Œå¿…é¡»çš„ç¬¬ä¸€æ­¥
        # https://github.com/actions/checkout
        # About: Action for checking out a repo
        uses: actions/checkout@v4

      # name: string
      # step å±‚
      # æ­¥éª¤åç§°ï¼ˆå»ºè®®å¡«å†™ï¼Œä¾¿äºæ—¥å¿—æŸ¥çœ‹ï¼‰

      # uses: string
      # step å±‚ï¼Œä¸ run äºŒé€‰ä¸€
      # ä½¿ç”¨ä¸€ä¸ªç°æˆçš„ GitHub Action

      # with: object
      # step å±‚
      # ç»™ uses çš„ Action ä¼ å‚

      - name: Setup Node.js
        # ç”¨äºè¿è¡Œ crx3 å·¥å…·çš„ Node ç¯å¢ƒ
        # https://github.com/actions/setup-node
        # About: Set up your GitHub Actions workflow with a specific version of node.js
        uses: actions/setup-node@v4
        with:
          # å‚æ•° node-version: æŒ‡å®š Node.js ç‰ˆæœ¬
          node-version: "23.11.0"

      # run: string
      # step å±‚ï¼Œä¸ uses äºŒé€‰ä¸€
      # æ‰§è¡Œ shell å‘½ä»¤

      - name: Install crx3 CLI
        # å®‰è£… crx3ï¼ˆæ”¯æŒ Manifest V3 çš„ .crx æ‰“åŒ…å·¥å…·ï¼‰
        # å®‰è£…ä¸ºå…¨å±€å‘½ä»¤ï¼Œå¯ä»¥æ‰§è¡Œ crx3 pack ...
        run: npm install -g crx3

      - name: Write private key file
        # æŠŠä¿å­˜åœ¨ GitHub Secrets é‡Œçš„ç§é’¥å†…å®¹å†™å…¥åˆ°æœ¬åœ°æ–‡ä»¶ mykey.pem
        # secrets.CRX_PRIVATE_KEY å¼•ç”¨ä½ åœ¨ä»“åº“ Settings â†’ Secrets ä¸­ä¿å­˜çš„å˜é‡
        run: echo "${{ secrets.CRX_PRIVATE_KEY }}" > mykey.pem

      - name: Build CRX package
        # crx3 pack ./: æ‰“åŒ…å½“å‰ç›®å½•ä¸º .crx æ‰©å±•
        # --key: æŒ‡å®šä½¿ç”¨å“ªä¸ªç§é’¥æ–‡ä»¶è¿›è¡Œç­¾å
        # --out: è¾“å‡ºçš„æ–‡ä»¶å
        run: crx3 pack ./ --key mykey.pem --out forvo-lookup.crx

      - name: Create Release and Upload CRX
        # https://github.com/softprops/action-gh-release
        # ğŸ“¦ GitHub Action for creating GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          # å‚æ•° tag_name: String
          # Name of a tag. defaults to github.ref_name
          # æ ‡ç­¾åç§°ï¼Œé»˜è®¤ä½¿ç”¨ github.ref_nameï¼ˆå³å½“å‰ Git æ ‡ç­¾ï¼‰
          tag_name: ${{ github.ref_name }}
          # å‚æ•° files: String
          # Newline-delimited globs of paths to assets to upload for release
          # ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒé€šé…ç¬¦å’Œå¤šè¡Œåˆ—å‡ºå¤šä¸ªæ–‡ä»¶
          files: ./forvo-lookup.crx
        env: # `env` è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¦‚è®¿é—®æƒé™
          # GITHUB_TOKEN: GitHub è‡ªåŠ¨æä¾›çš„ä»¤ç‰Œï¼Œå…·æœ‰å‘å¸ƒæƒé™
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
